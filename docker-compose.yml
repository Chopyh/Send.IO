services:
  # ---------------------------------------------------------------------------
  # BACKEND (Laravel API)
  # ---------------------------------------------------------------------------
  api:
    build: ./sendio-api
    container_name: sendio_api_prod
    restart: always
    networks:
      - dokploy-network
    environment:
      # --- Aplicación ---
      APP_NAME: ${APP_NAME:-SendIO}
      APP_ENV: production
      APP_KEY: ${APP_KEY}
      APP_DEBUG: false
      APP_URL: https://sendio.chopy.me
      
      # --- Logging (Vital para ver logs en Mongo) ---
      LOG_CHANNEL: mongodb
      LOG_LEVEL: debug
      
      # --- Drivers ---
      SESSION_DRIVER: mongodb
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis

      # --- PostgreSQL ---
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

      # --- MongoDB ---
      MONGODB_URI: mongodb://${MONGO_INITDB_USER}:${MONGO_INITDB_PASSWORD}@mongodb:27017?authSource=admin
      MONGODB_DATABASE: ${MONGODB_DATABASE}

      # --- Redis ---
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PORT: 6379

  # ---------------------------------------------------------------------------
  # FRONTEND (Angular + Nginx)
  # ---------------------------------------------------------------------------
  front:
    build: ./sendio-front
    container_name: sendio_front_prod
    restart: always
    networks:
      - dokploy-network

  # ---------------------------------------------------------------------------
  # DATABASES (Seguras y Accesibles solo vía SSH Tunnel)
  # ---------------------------------------------------------------------------
  
  postgres:
    image: postgres:16-alpine
    container_name: sendio_db_prod
    restart: always
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - pg_prod_data:/var/lib/postgresql/data
    networks:
      - dokploy-network

  mongodb:
    image: mongo:latest
    container_name: sendio_mongo_prod
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_PASSWORD}
    ports:
      - "127.0.0.1:27017:27017"
    volumes:
      - mongo_prod_data:/data/db
    networks:
      - dokploy-network

  redis:
    image: redis:alpine
    container_name: sendio_redis_prod
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --save 60 1 --loglevel warning
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_prod_data:/data
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true

volumes:
  pg_prod_data:
  mongo_prod_data:
  redis_prod_data: